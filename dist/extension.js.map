{"version":3,"file":"extension.js","mappings":"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","sources":[".././src/XMindDocument.ts",".././src/XMindEditorProvider.ts","../external commonjs \"vscode\"",".././src/dispose.ts",".././src/util.ts","../webpack/bootstrap",".././src/extension.ts"],"sourcesContent":["import * as vscode from 'vscode';\nimport { Disposable } from './dispose';\n\nexport interface XMindDocumentDelegate {\n    getFileData(): Promise<Uint8Array>;\n    undo(): Promise<void>;\n    redo(): Promise<void>;\n}\n\nexport class XMindDocument extends Disposable implements vscode.CustomDocument {\n\n    static async create(\n        uri: vscode.Uri,\n        backupId: string | undefined,\n        delegate: XMindDocumentDelegate,\n    ): Promise<XMindDocument | PromiseLike<XMindDocument>> {\n        const dataFile = typeof backupId === 'string' ? vscode.Uri.parse(backupId) : uri;\n        const fileData = await XMindDocument.readFile(dataFile);\n        return new XMindDocument(uri, fileData, delegate);\n    }\n\n    private static async readFile(uri: vscode.Uri): Promise<Uint8Array> {\n        if (uri.scheme === 'untitled') {\n            return new Uint8Array();\n        }\n        return new Uint8Array(await vscode.workspace.fs.readFile(uri));\n    }\n\n    private readonly _uri: vscode.Uri;\n    private _documentData: Uint8Array;\n    private readonly _delegate: XMindDocumentDelegate;\n\n    private constructor(\n        uri: vscode.Uri,\n        initialContent: Uint8Array,\n        delegate: XMindDocumentDelegate\n    ) {\n        super();\n        this._uri = uri;\n        this._documentData = initialContent;\n        this._delegate = delegate;\n    }\n\n    public get uri() { return this._uri; }\n\n    public get documentData(): Uint8Array { return this._documentData; }\n\n    private readonly _onDidDispose = this._register(new vscode.EventEmitter<void>());\n    public readonly onDidDispose = this._onDidDispose.event;\n\n    private readonly _onDidChangeDocument = this._register(new vscode.EventEmitter<{\n        readonly content?: Uint8Array;\n    }>());\n    public readonly onDidChangeContent = this._onDidChangeDocument.event;\n\n    private readonly _onDidChange = this._register(new vscode.EventEmitter<{\n        readonly label: string,\n        undo(): void,\n        redo(): void,\n    }>());\n    public readonly onDidChange = this._onDidChange.event;\n\n    dispose(): void {\n        this._onDidDispose.fire();\n        super.dispose();\n    }\n\n    /**\n     * Called when the webview notifies us that the document has changed.\n     */\n    makeEdit() {\n        this._onDidChange.fire({\n            label: 'Edit',\n            undo: async () => {\n                await this._delegate.undo();\n            },\n            redo: async () => {\n                await this._delegate.redo();\n            }\n        });\n    }\n\n    /**\n     * Called by VS Code when the user saves the document.\n     */\n    async save(cancellation: vscode.CancellationToken): Promise<void> {\n        await this.saveAs(this.uri, cancellation);\n    }\n\n    /**\n     * Called by VS Code when the user saves the document to a new location.\n     */\n    async saveAs(targetResource: vscode.Uri, cancellation: vscode.CancellationToken): Promise<void> {\n        const fileData = await this._delegate.getFileData();\n        if (cancellation.isCancellationRequested) {\n            return;\n        }\n        await vscode.workspace.fs.writeFile(targetResource, fileData);\n    }\n\n    /**\n     * Called by VS Code when the user calls `revert` on a document.\n     */\n    async revert(_cancellation: vscode.CancellationToken): Promise<void> {\n        const diskContent = await XMindDocument.readFile(this.uri);\n        this._documentData = diskContent;\n        this._onDidChangeDocument.fire({\n            content: diskContent,\n        });\n    }\n\n    /**\n     * Called by VS Code to backup the edited document.\n     */\n    async backup(destination: vscode.Uri, cancellation: vscode.CancellationToken): Promise<vscode.CustomDocumentBackup> {\n        await this.saveAs(destination, cancellation);\n        return {\n            id: destination.toString(),\n            delete: async () => {\n                try {\n                    await vscode.workspace.fs.delete(destination);\n                } catch {\n                    // noop\n                }\n            }\n        };\n    }\n}\n","import * as vscode from 'vscode';\nimport { XMindDocument } from './XMindDocument';\nimport { disposeAll } from './dispose';\nimport { getNonce } from './util';\n\n/**\n * Provider for XMind editors.\n */\nexport class XMindEditorProvider implements vscode.CustomEditorProvider<XMindDocument> {\n\n    public static register(context: vscode.ExtensionContext): vscode.Disposable {\n        const provider = new XMindEditorProvider(context);\n        const providerRegistration = vscode.window.registerCustomEditorProvider(XMindEditorProvider.viewType, provider, {\n            webviewOptions: {\n                retainContextWhenHidden: true,\n            },\n            supportsMultipleEditorsPerDocument: false,\n        });\n\n        // Register export commands\n        context.subscriptions.push(\n            vscode.commands.registerCommand('xmind.exportPNG', (uri?: vscode.Uri) => provider.triggerExport('png', uri)),\n            vscode.commands.registerCommand('xmind.exportSVG', (uri?: vscode.Uri) => provider.triggerExport('svg', uri)),\n            vscode.commands.registerCommand('xmind.exportMarkdown', (uri?: vscode.Uri) => provider.triggerExport('md', uri))\n        );\n\n        return providerRegistration;\n    }\n\n    private static readonly viewType = 'vscode-xmind-viewer.xmindEditor';\n\n    /**\n     * Tracks all known webviews\n     */\n    private readonly webviews = new WebviewCollection();\n\n    constructor(\n        private readonly context: vscode.ExtensionContext\n    ) { }\n\n    //#region CustomEditorProvider\n\n    async openCustomDocument(\n        uri: vscode.Uri,\n        openContext: { backupId?: string },\n        _token: vscode.CancellationToken\n    ): Promise<XMindDocument> {\n        const document = await XMindDocument.create(uri, openContext.backupId, {\n            getFileData: async () => {\n                const webviewsForDocument = Array.from(this.webviews.get(document.uri));\n                if (!webviewsForDocument.length) {\n                    throw new Error('Could not find webview to save for');\n                }\n                const panel = webviewsForDocument[0];\n                const response = await this.postMessageWithResponse<number[]>(panel, 'getFileData', {});\n                return new Uint8Array(response);\n            },\n            undo: async () => {\n                for (const panel of this.webviews.get(document.uri)) {\n                    this.postMessage(panel, 'undo', {});\n                }\n            },\n            redo: async () => {\n                for (const panel of this.webviews.get(document.uri)) {\n                    this.postMessage(panel, 'redo', {});\n                }\n            }\n        });\n\n        const listeners: vscode.Disposable[] = [];\n\n        listeners.push(document.onDidChange(e => {\n            // Propagate document changes to VS Code (dirty state)\n            this._onDidChangeCustomDocument.fire({\n                document,\n                ...e,\n            });\n        }));\n\n        listeners.push(document.onDidChangeContent(e => {\n            // Propagate external file changes to the webview\n            for (const webviewPanel of this.webviews.get(document.uri)) {\n                this.postMessage(webviewPanel, 'update', {\n                    data: Array.from(e.content ?? new Uint8Array())\n                });\n            }\n        }));\n\n        listeners.push(vscode.window.onDidChangeActiveColorTheme(e => {\n            for (const panel of this.webviews.get(uri)) {\n                this.postMessage(panel, 'theme-change', {\n                    kind: e.kind\n                });\n            }\n        }));\n\n        document.onDidDispose(() => disposeAll(listeners));\n\n        return document;\n    }\n\n    async resolveCustomEditor(\n        document: XMindDocument,\n        webviewPanel: vscode.WebviewPanel,\n        _token: vscode.CancellationToken\n    ): Promise<void> {\n        // Add the webview to our internal set of active webviews\n        this.webviews.add(document.uri, webviewPanel);\n\n        // Setup initial options\n        webviewPanel.webview.options = {\n            enableScripts: true,\n        };\n\n        // Attach listeners BEFORE setting the HTML to avoid missing the 'ready' message\n        webviewPanel.webview.onDidReceiveMessage(e => this.onMessage(document, e));\n\n        webviewPanel.webview.onDidReceiveMessage(e => {\n            if (e.type === 'ready') {\n                const data = document.documentData;\n                this.postMessage(webviewPanel, 'update', {\n                    data: Array.from(data)\n                });\n            }\n        });\n\n        webviewPanel.webview.html = this.getHtmlForWebview(webviewPanel.webview);\n    }\n\n    private readonly _onDidChangeCustomDocument = new vscode.EventEmitter<vscode.CustomDocumentEditEvent<XMindDocument>>();\n    public readonly onDidChangeCustomDocument = this._onDidChangeCustomDocument.event;\n\n    public saveCustomDocument(document: XMindDocument, cancellation: vscode.CancellationToken): Thenable<void> {\n        return document.save(cancellation);\n    }\n\n    public saveCustomDocumentAs(document: XMindDocument, destination: vscode.Uri, cancellation: vscode.CancellationToken): Thenable<void> {\n        return document.saveAs(destination, cancellation);\n    }\n\n    public revertCustomDocument(document: XMindDocument, cancellation: vscode.CancellationToken): Thenable<void> {\n        return document.revert(cancellation);\n    }\n\n    public backupCustomDocument(document: XMindDocument, context: vscode.CustomDocumentBackupContext, cancellation: vscode.CancellationToken): Thenable<vscode.CustomDocumentBackup> {\n        return document.backup(context.destination, cancellation);\n    }\n\n    //#endregion\n\n    private _requestIdPool = 0;\n    private _callbacks = new Map<number, (response: any) => void>();\n\n    private postMessage(panel: vscode.WebviewPanel, type: string, body: any): void {\n        panel.webview.postMessage({ type, body });\n    }\n\n    private triggerExport(type: string, uri?: vscode.Uri) {\n        let activePanel: vscode.WebviewPanel | undefined;\n\n        // Priority 0: Try to find panel by URI (passed from command context)\n        if (uri && uri instanceof vscode.Uri) {\n            const panels = Array.from(this.webviews.get(uri));\n            if (panels.length > 0) {\n                // Pick the active or visible one first, otherwise just the first one\n                activePanel = panels.find(p => p.active) || panels.find(p => p.visible) || panels[0];\n            }\n        }\n\n        if (!activePanel) {\n            activePanel = this.webviews.activePanel;\n        }\n\n        if (activePanel) {\n            this.postMessage(activePanel, 'export', { type }); // Send to webview to trigger export logic\n        } else {\n            vscode.window.showErrorMessage('No active XMind editor found.');\n        }\n    }\n\n\n\n    private postMessageWithResponse<R = any>(panel: vscode.WebviewPanel, type: string, body: any): Promise<R> {\n        const requestId = this._requestIdPool++;\n        const p = new Promise<R>(resolve => {\n            this._callbacks.set(requestId, resolve);\n        });\n        panel.webview.postMessage({ type, requestId, body });\n        return p;\n    }\n\n    private onMessage(document: XMindDocument, message: any) {\n        switch (message.type) {\n            case 'edit':\n                document.makeEdit();\n                break;\n            case 'undo':\n            case 'redo':\n                // For now, these are handled via webview postMessage initiated from HTML buttons\n                // If we want to support VS Code side undo, we'd need to forward this to all webviews\n                for (const panel of this.webviews.get(document.uri)) {\n                    this.postMessage(panel, message.type, {});\n                }\n                break;\n            case 'response':\n                const callback = this._callbacks.get(message.requestId);\n                callback?.(message.body);\n                return;\n            case 'save-export':\n                this.handleSaveExport(document, message.body);\n                break;\n            case 'error':\n                vscode.window.showErrorMessage(message.body);\n                break;\n        }\n    }\n\n    private async handleSaveExport(document: XMindDocument, data: { content: string, type: string, filename: string }) {\n        let defaultUri: vscode.Uri;\n        const workspaceFolder = vscode.workspace.getWorkspaceFolder(document.uri);\n        if (workspaceFolder) {\n            defaultUri = vscode.Uri.joinPath(workspaceFolder.uri, data.filename);\n        } else {\n            // Fallback: directory of the current file\n            defaultUri = vscode.Uri.joinPath(document.uri, '..', data.filename);\n        }\n\n        const options: vscode.SaveDialogOptions = {\n            defaultUri: defaultUri,\n            filters: {}\n        };\n        if (data.type === 'png') options.filters!['Images'] = ['png'];\n        if (data.type === 'svg') options.filters!['SVG'] = ['svg'];\n        if (data.type === 'md') options.filters!['Markdown'] = ['md'];\n\n        const uri = await vscode.window.showSaveDialog(options);\n        if (uri) {\n            let buffer: Uint8Array;\n            if (data.type === 'png') {\n                const base64Data = data.content.split(',')[1];\n                buffer = Buffer.from(base64Data, 'base64');\n            } else {\n                buffer = Buffer.from(data.content, 'utf8');\n            }\n            await vscode.workspace.fs.writeFile(uri, buffer);\n            vscode.window.showInformationMessage(`Successfully exported to ${uri.fsPath}`);\n        }\n    }\n\n    private getHtmlForWebview(webview: vscode.Webview): string {\n        const scriptUri = webview.asWebviewUri(vscode.Uri.joinPath(this.context.extensionUri, 'dist', 'webview.js'));\n        const nonce = getNonce();\n\n        return `\n\t\t\t<!DOCTYPE html>\n\t\t\t<html lang=\"en\">\n\t\t\t<head>\n\t\t\t\t<meta charset=\"UTF-8\">\n\t\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\t\t\t\t<title>XMind Viewer</title>\n                <style>\n                    html, body { \n                        margin: 0; \n                        padding: 0; \n                        width: 100%; \n                        height: 100%; \n                        overflow: hidden; \n                        background-color: #fff; \n                        font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n                        display: flex;\n                        flex-direction: column;\n                    }\n                    .vscode-dark, .vscode-dark body {\n                        background-color: #1e1e1e;\n                        color: #ccc;\n                    }\n                    #mindmap { \n                        flex: 1;\n                        width: 100%; \n                        height: 0;\n                        position: relative;\n                        background: #fff;\n                    }\n                    .vscode-dark #mindmap {\n                        background: #1e1e1e;\n                    }\n                    #tab-container {\n                        flex-shrink: 0;\n                        height: 34px; /* Slightly slimmer */\n                        background: #f8f8f8;\n                        border-top: 1px solid #ddd;\n                        display: flex;\n                        align-items: center;\n                        padding: 0 12px;\n                        overflow: hidden;\n                        z-index: 100;\n                        justify-content: space-between;\n                        box-shadow: 0 -2px 5px rgba(0,0,0,0.05);\n                    }\n                    #history-controls, #controls {\n                        display: flex;\n                        align-items: center;\n                        gap: 6px;\n                        flex-shrink: 0;\n                    }\n                    #history-controls button, #controls button {\n                        background: transparent;\n                        border: 1px solid transparent;\n                        border-radius: 4px;\n                        padding: 4px;\n                        cursor: pointer;\n                        font-size: 16px;\n                        line-height: 1;\n                        transition: all 0.2s;\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                        color: #666;\n                    }\n                    #history-controls button:hover, #controls button:hover {\n                        background: #eee;\n                        border-color: #ccc;\n                        color: #333;\n                    }\n                    #tabs-wrapper { \n                        flex-grow: 1;\n                        display: flex;\n                        align-items: center;\n                        height: 100%;\n                        overflow-x: auto;\n                        -webkit-overflow-scrolling: touch;\n                        margin: 0 15px;\n                    }\n                    #tabs-wrapper::-webkit-scrollbar { display: none; }\n                    .tab { \n                        padding: 4px 12px; \n                        margin-right: 4px; \n                        cursor: pointer; \n                        font-size: 11px; \n                        color: #666; \n                        background: #ececec;\n                        border: 1px solid #ddd;\n                        border-bottom: none;\n                        border-radius: 4px 4px 0 0;\n                        white-space: nowrap;\n                        transition: all 0.2s;\n                        align-self: flex-end;\n                        display: flex;\n                        align-items: center;\n                        gap: 8px;\n                        max-width: 140px; /* Limit width */\n                    }\n                    .tab span {\n                        overflow: hidden;\n                        text-overflow: ellipsis;\n                        white-space: nowrap;\n                    }\n                    .tab-close {\n                        font-size: 12px;\n                        color: #aaa;\n                        border-radius: 50%;\n                        width: 14px;\n                        height: 14px;\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                        line-height: 1;\n                        opacity: 0.6;\n                        transition: all 0.2s;\n                    }\n                    .tab-close:hover {\n                        background: #ff4d4f;\n                        color: #fff;\n                        opacity: 1;\n                    }\n                    .tab.active { \n                        background: #fff; \n                        color: #000; \n                        font-weight: 600;\n                        position: relative;\n                        top: 1px;\n                        border-bottom: 2px solid #fff;\n                        box-shadow: 0 -2px 4px rgba(0,0,0,0.03);\n                    }\n                    select {\n                        background: #fff;\n                        border: 1px solid #ddd;\n                        border-radius: 4px;\n                        font-size: 11px;\n                        padding: 2px 4px;\n                        outline: none;\n                        color: #666;\n                    }\n                    .export-dropdown {\n                        position: relative;\n                        display: inline-block;\n                    }\n                    .dropdown-content {\n                        display: none;\n                        position: absolute;\n                        right: 0;\n                        bottom: 40px;\n                        background-color: #f9f9f9;\n                        min-width: 130px;\n                        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);\n                        z-index: 1000;\n                        border-radius: 4px;\n                        overflow: hidden;\n                    }\n                    .vscode-dark .dropdown-content {\n                        background-color: #2d2d2d;\n                        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);\n                    }\n                    .dropdown-content a {\n                        color: #333;\n                        padding: 8px 12px;\n                        text-decoration: none;\n                        display: block;\n                        font-size: 12px;\n                    }\n                    .vscode-dark .dropdown-content a { color: #ccc; }\n                    .dropdown-content a:hover { background-color: #eee; }\n                    .vscode-dark .dropdown-content a:hover { background-color: #3e3e3e; }\n                    .export-dropdown.open .dropdown-content { display: block; }\n                    /* 暗色模式样式 - Sheet 栏 */\n                    .vscode-dark #tab-container {\n                        background: #252526;\n                        border-top-color: #3c3c3c;\n                        box-shadow: 0 -2px 5px rgba(0,0,0,0.2);\n                    }\n                    .vscode-dark #history-controls button, .vscode-dark #controls button {\n                        color: #ccc;\n                    }\n                    .vscode-dark #history-controls button:hover, .vscode-dark #controls button:hover {\n                        background: #3c3c3c;\n                        border-color: #555;\n                        color: #fff;\n                    }\n                    .vscode-dark .tab {\n                        background: #333 !important;\n                        color: #aaa !important;\n                        border-color: #444 !important;\n                    }\n                    .vscode-dark .tab.active {\n                        background: #1e1e1e !important;\n                        color: #e0e0e0 !important;\n                        border-bottom-color: #1e1e1e !important;\n                    }\n                    .vscode-dark .tab-close {\n                        color: #888;\n                    }\n                    .vscode-dark select {\n                        background: #3c3c3c;\n                        border-color: #555;\n                        color: #ccc;\n                    }\n\n                </style>\n\t\t\t</head>\n\t\t\t<body class=\"${vscode.window.activeColorTheme.kind === vscode.ColorThemeKind.Dark || vscode.window.activeColorTheme.kind === vscode.ColorThemeKind.HighContrast ? 'vscode-dark' : 'vscode-light'}\">\n\t\t\t\t<div id=\"mindmap\"></div>\n                <div id=\"tab-container\"></div>\n\t\t\t\t<script nonce=\"${nonce}\" src=\"${scriptUri}\"></script>\n\t\t\t</body>\n\t\t\t</html>`;\n    }\n}\n\n/**\n * Tracks all webviews.\n */\nclass WebviewCollection {\n    private readonly _webviews = new Set<{ readonly resource: string; readonly webviewPanel: vscode.WebviewPanel; }>();\n\n    public *get(uri: vscode.Uri): Iterable<vscode.WebviewPanel> {\n        const key = uri.toString();\n        for (const entry of this._webviews) {\n            if (entry.resource === key) {\n                yield entry.webviewPanel;\n            }\n        }\n    }\n\n    public add(uri: vscode.Uri, webviewPanel: vscode.WebviewPanel) {\n        const entry = { resource: uri.toString(), webviewPanel };\n        this._webviews.add(entry);\n\n        webviewPanel.onDidDispose(() => {\n            this._webviews.delete(entry);\n        });\n    }\n\n    public get activePanel(): vscode.WebviewPanel | undefined {\n        const entries = Array.from(this._webviews);\n        // Priority 1: Strictly active panel\n        const activeEntry = entries.find(entry => entry.webviewPanel.active);\n        if (activeEntry) {\n            return activeEntry.webviewPanel;\n        }\n\n        // Priority 2: If only one panel is visible, assume it's the target (handles focus loss cases)\n        const visibleEntries = entries.filter(entry => entry.webviewPanel.visible);\n        if (visibleEntries.length === 1) {\n            return visibleEntries[0].webviewPanel;\n        }\n\n        // Priority 3: Fallback - if there is only one webview in total, us it.\n        // This covers cases where the user clicked a command from the title bar (stealing focus)\n        // and VS Code hasn't updated the active/visible state yet, or for single-file users.\n        if (entries.length === 1) {\n            return entries[0].webviewPanel;\n        }\n\n        return undefined;\n    }\n}\n","module.exports = require(\"vscode\");","import * as vscode from 'vscode';\n\nexport class Disposable {\n    private readonly _disposables: vscode.Disposable[] = [];\n\n    public dispose() {\n        while (this._disposables.length) {\n            const item = this._disposables.pop();\n            if (item) {\n                item.dispose();\n            }\n        }\n    }\n\n    protected _register<T extends vscode.Disposable>(value: T): T {\n        this._disposables.push(value);\n        return value;\n    }\n}\n\nexport function disposeAll(disposables: vscode.Disposable[]) {\n    while (disposables.length) {\n        const item = disposables.pop();\n        if (item) {\n            item.dispose();\n        }\n    }\n}\n","export function getNonce() {\n    let text = '';\n    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    for (let i = 0; i < 32; i++) {\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\n    }\n    return text;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import * as vscode from 'vscode';\nimport { XMindEditorProvider } from './XMindEditorProvider';\n\nexport function activate(context: vscode.ExtensionContext) {\n    // Register our custom editor provider\n    context.subscriptions.push(XMindEditorProvider.register(context));\n}\n\nexport function deactivate() { }\n"],"names":["XMindDocument","Disposable","create","uri","backupId","delegate","dataFile","vscode","Uri","parse","fileData","readFile","scheme","Uint8Array","workspace","fs","initialContent","super","_onDidDispose","this","_register","EventEmitter","onDidDispose","event","_onDidChangeDocument","onDidChangeContent","_onDidChange","onDidChange","_uri","_documentData","_delegate","documentData","dispose","fire","makeEdit","label","undo","redo","save","cancellation","saveAs","targetResource","getFileData","isCancellationRequested","writeFile","revert","_cancellation","diskContent","content","backup","destination","id","toString","delete","XMindEditorProvider","register","context","provider","providerRegistration","window","registerCustomEditorProvider","viewType","webviewOptions","retainContextWhenHidden","supportsMultipleEditorsPerDocument","subscriptions","push","commands","registerCommand","triggerExport","constructor","webviews","WebviewCollection","_onDidChangeCustomDocument","onDidChangeCustomDocument","_requestIdPool","_callbacks","Map","openCustomDocument","openContext","_token","document","webviewsForDocument","Array","from","get","length","Error","panel","response","postMessageWithResponse","postMessage","listeners","e","webviewPanel","data","onDidChangeActiveColorTheme","kind","disposeAll","resolveCustomEditor","add","webview","options","enableScripts","onDidReceiveMessage","onMessage","type","html","getHtmlForWebview","saveCustomDocument","saveCustomDocumentAs","revertCustomDocument","backupCustomDocument","body","activePanel","panels","find","p","active","visible","showErrorMessage","requestId","Promise","resolve","set","message","callback","handleSaveExport","defaultUri","workspaceFolder","getWorkspaceFolder","joinPath","filename","filters","showSaveDialog","buffer","base64Data","split","Buffer","showInformationMessage","fsPath","scriptUri","asWebviewUri","extensionUri","nonce","getNonce","activeColorTheme","ColorThemeKind","Dark","HighContrast","_webviews","Set","key","entry","resource","entries","activeEntry","visibleEntries","filter","module","exports","require","disposables","item","pop","_disposables","value","text","i","charAt","Math","floor","possible","random","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","call"],"ignoreList":[],"sourceRoot":""}